---
- name: Upload the k8s admin manifest to the remote host
  copy:
    src: "{{ playbook_dir }}/admin.yaml"
    dest: /tmp/admin.yaml
    mode: '0755'

- name: Execute the script on the remote host
  shell: kubectl apply -f /tmp/admin.yaml

- name: Upload the script to the remote host
  copy:
    src: "{{ playbook_dir }}/generate-config.sh"
    dest: /tmp/generate_output.sh
    mode: '0755'

- name: Execute the script on the remote host
  shell: /tmp/generate_output.sh > /tmp/config.yaml

- name: Fetch the generated file
  fetch:
    src: /tmp/config.yaml
    dest: "{{ playbook_dir }}/config.yaml"
    flat: yes

- name: get server token from remote
  shell: echo SERVER_TOKEN=`cat /var/lib/rancher/k3s/server/agent-token` > /tmp/token

- name: Fetch server token file
  fetch:
    src: /tmp/token
    dest: "{{ playbook_dir }}/token.env"
    flat: yes
